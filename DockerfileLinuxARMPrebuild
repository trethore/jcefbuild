#This file is used to build java classes for ARMv6 distributions before actually running on ARMv6
#This is needed as compilation fails on ARMv6 for some yet unknown reasons (libraries do not get detected there)

FROM debian:bullseye AS stage

LABEL jcefbuild=true

#Step 1: Install required tools and libs
ENV DEBIAN_FRONTEND=noninteractive
ENV TOOLS="openjdk-11-jdk python3 python-is-python3 cmake git gcc build-essential libgtk2.0-dev ninja-build rsync curl libgbm-dev libxkbcommon-dev libpango1.0-dev libcairo-dev ca-certificates"
ENV LIBS="libnss3 libnspr4 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgbm1 libasound2 libatspi2.0-0 libxshmfence1 libc6-armhf-cross"
RUN apt-get -q update && \
    apt-get -q install -y --fix-missing -o Acquire::Retries=5 --no-install-recommends $TOOLS $LIBS && \
    rm -rf /var/lib/apt/lists/*
#Create link to re-enable support for linux arm builds
RUN ln -sf /usr/arm-linux-gnueabihf/lib/ld-linux-armhf.so.3 /usr/lib/ld-linux-armhf.so.3

#Declare build type argument (Release or Debug)
ARG BUILD_TYPE

#Declare architecture argument (arm64, 386 or amd64)
ARG TARGETARCH

#Declare git args
ARG REPO
ARG REF

WORKDIR /builder
#Copy existing sources, if any
COPY jcef /jcef

#Copy and launch run script
COPY scripts/run_linux_prebuild.sh .
RUN chmod +x run_linux_prebuild.sh
RUN ./run_linux_prebuild.sh

#Export built files
FROM scratch AS export-stage
COPY --from=stage /jcef/out/linux32 linux32
