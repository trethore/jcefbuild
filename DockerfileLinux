FROM debian:bullseye AS stage

LABEL jcefbuild=true

#Step 1: Install required tools and libs
ENV DEBIAN_FRONTEND=noninteractive
ENV TOOLS="openjdk-11-jdk python3 python-is-python3 cmake git gcc build-essential libgtk2.0-dev ninja-build rsync curl libgbm-dev libxkbcommon-dev libpango1.0-dev libcairo-dev ca-certificates"
ENV LIBS="libnss3 libnspr4 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libgbm1 libasound2 libatspi2.0-0 libxshmfence1 libc6-armhf-cross"
RUN apt-get -q update && \
    apt-get -q install -y --fix-missing -o Acquire::Retries=5 --no-install-recommends $TOOLS $LIBS && \
    rm -rf /var/lib/apt/lists/*
#Create link to re-enable support for linux arm builds
RUN ln -sf /usr/arm-linux-gnueabihf/lib/ld-linux-armhf.so.3 /usr/lib/ld-linux-armhf.so.3

#Declare build type argument (Release or Debug)
ARG BUILD_TYPE

#Declare architecture argument (arm64, arm/v6, 386 or amd64)
ARG TARGETARCH

#Declare git args
ARG REPO
ARG REF

WORKDIR /builder
#Copy existing sources, if any
COPY jcef /jcef
#Copy prebuild classes, if any
COPY out/linux32 /prebuild

#Copy cmake patching script
COPY scripts/patch_cmake.py .
COPY scripts/patch_jcef_tools.py .
COPY patch/CMakeLists.txt.patch .

#Copy and launch run script
COPY scripts/run_linux.sh .
RUN chmod +x run_linux.sh
RUN ./run_linux.sh

#Export built files
FROM scratch AS export-stage
COPY --from=stage /jcef/binary_distrib.tar.gz .
#COPY --from=stage /jcef/target target
#COPY --from=stage /jcef/third_party third_party
#COPY --from=stage /jcef/buildtools buildtools
#COPY --from=stage /jcef/jcef_build jcef_build
